{% extends 'layout.html' %} {% block content %} {% include
'./header/mainHeader.html' with context %}
<ul class="flex flex-row gap-[10px] overflow-auto my-6 mx-2" id="filters"></ul>
<ul class="flex flex-col mx-2 mt-[38px] gap-[20px] h-[78vh] overflow-auto">
  {% for post in posts %}
  <li class="flex flex-col gap-[8px] border-b-[1px] pb-4">
    <div class="flex justify-between items-center w-full">
      <div class="flex gap-10 items-center w-2/3 font-semibold text-[18px]">
        <span>{{ post.departure }}</span>
        <i class="fa-solid fa-arrow-right text-gray-400"></i>
        <span>{{ post.destination }}</span>
      </div>
      <div>
        <i class="fa-solid fa-users text-gray-400"></i>
        <span>{{ post.current_count }}/{{ post.rides_limit }}</span>
      </div>
    </div>
    <div class="flex gap-2 items-center">
      <i class="fa-solid fa-circle text-red-600"></i>
      <span>{{ post.date }}</span>
    </div>
    <p class="text-[14px] h-[50px] min-h-[50px] py-2">
      {{ post.memo }}
    </p>
    <div class="flex justify-end items-center gap-2 text-[14px]">
      {% if post.user_id == session.user_id %}
      <button class="w-[68px] py-1 text-gray-400 bg-gray-100 rounded-sm" onclick="window.location.href='/edit/{{ post._id }}'">수정</button>
      <button class="w-[68px] py-1 text-gray-400 bg-gray-100 rounded-sm" onclick="deletePost('{{ post._id }}')">삭제</button>
      {% else %}
      <button class="w-[68px] py-1 bg-Low text-Strong rounded-sm" onclick="participate('{{ post._id }}')">참여</button>
      {% endif %}
    </div>
  </li>
  {% endfor %}
</ul>
<div class="sticky bottom-12 ml-auto mr-4">
  <a
    aria-label="new-post-button"
    class="w-[60px] h-[60px] rounded-full bg-Primary flex items-center justify-center shadow-lg"
    href="/posts/new"
  >
    <i class="fa-solid fa-plus text-[24px] text-white"></i>
  </a>
</div>
{% endblock %}

{% block script %}

{% set script_required = true %}
{% set script_file = 'javascripts/posts.js' %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    function deletePost(postId) {
      fetch(`/posts/${postId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          alert(data.message);
          location.reload();
        } else {
          alert(data.error);
        }
      });
    }

    function participate(postId) {
      fetch(`/posts/${postId}/participation`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ user_id: '{{ session.user_id }}' })
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          alert(data.message);
          location.reload();
        } else {
          alert(data.error);
        }
      });
    }

    document.querySelectorAll("button[onclick*='participate']").forEach(button => {
      button.addEventListener('click', function(event) {
        event.preventDefault();
        const postId = this.getAttribute('onclick').match(/'([^']+)'/)[1];
        participate(postId);
      });
    });

    document.querySelectorAll("button[onclick*='deletePost']").forEach(button => {
      button.addEventListener('click', function(event) {
        event.preventDefault();
        const postId = this.getAttribute('onclick').match(/'([^']+)'/)[1];
        deletePost(postId);
      });
    });
  });
</script>


{% endblock %}
